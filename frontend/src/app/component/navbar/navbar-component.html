<nav>
  <div class="flex-shrink-0 z-10">
    <button (click)="onCreateChallenge()" class="btn-create">
      <lucide-icon [img]="icons.PlusCircle" class="w-5 h-5"></lucide-icon>
      <span>Create Challenge</span>
    </button>
  </div>

  <div class="absolute left-1/2 transform -translate-x-1/2 hidden md:flex items-center gap-4">
    <a *ngFor="let link of navLinks"
       [routerLink]="link.path"
       routerLinkActive="active"
       [routerLinkActiveOptions]="{exact: link.path === '/'}"
       class="nav-btn cursor-pointer">
      {{ link.label }}
    </a>
  </div>

  <div class="ml-auto relative z-10 flex items-center gap-4">

    <div class="relative">
      <button (click)="toggleNotifications()" class="relative p-2 text-gray-400 hover:text-white transition rounded-full hover:bg-white/10">
        <lucide-icon [img]="icons.Bell" class="w-6 h-6"></lucide-icon>
        <span *ngIf="unreadCount() > 0"
              class="absolute top-1 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-600 text-[10px] font-bold text-white border-2 border-[#14121b]">
          {{ unreadCount() }}
        </span>
      </button>

      <div *ngIf="isNotificationsOpen"
           class="absolute right-0 top-full mt-2 w-80 bg-[#1a1627] border border-gray-700 rounded-xl shadow-2xl overflow-hidden z-50 animate-fade-in origin-top-right">

        <div class="p-3 border-b border-gray-700 font-bold text-white flex justify-between">
          <span>Notifications</span>
        </div>

        <div class="max-h-80 overflow-y-auto custom-scrollbar">
          <div *ngIf="notifications().length === 0" class="p-6 text-center text-gray-500 text-sm">
            No new notifications.
          </div>

          <div *ngFor="let notif of notifications()"
               (click)="onNotificationClick(notif)"
               class="p-3 border-b border-gray-700/50 hover:bg-gray-800 cursor-pointer transition flex gap-3 items-start relative group">

            <div class="mt-1 flex-shrink-0">
              <lucide-icon
                [img]="getIconForType(notif.type)"
                [class]="notif.isRead ? 'text-gray-500 w-5 h-5' : 'text-blue-400 w-5 h-5'">
              </lucide-icon>
            </div>

            <div class="flex-1">
              <p class="text-sm text-gray-300 group-hover:text-white transition"
                 [class.font-bold]="!notif.isRead">
                {{ notif.message }}
              </p>

              <p class="text-xs text-gray-500 mt-1">
                {{ notif.timestamp | timeAgo }}
              </p>
            </div>

            <div *ngIf="!notif.isRead" class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
          </div>
        </div>
      </div>
    </div>
    <div (click)="toggleDropdown()"
         class="flex items-center gap-4 cursor-pointer p-2 rounded-xl border border-transparent transition select-none user-profile-container group hover:bg-white/5">

      <div class="hidden md:flex flex-col items-end">
        <span class="text-white font-bold text-base group-hover:text-purple-300 transition">{{ username }}</span>
        <div class="flex items-center gap-2 text-xs">
          <span class="text-gray-400 font-semibold uppercase tracking-wider">Lvl {{ userLevel || 1 }}</span>
          <span class="text-yellow-400 font-bold bg-yellow-400/10 px-2 py-0.5 rounded border border-yellow-400/20">üèÜ {{ userPoints }} XP</span>
        </div>
      </div>

      <div class="relative">
        <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg border-2 border-gray-700 group-hover:border-purple-500 transition overflow-hidden bg-gradient-to-br from-purple-600 to-blue-600">
          <img *ngIf="user()?.avatar" [src]="'/avatars/' + user().avatar" class="w-full h-full object-cover" alt="Avatar">
          <span *ngIf="!user()?.avatar">{{ userInitials }}</span>
        </div>
        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#14121b] rounded-full"></div>
      </div>

      <lucide-icon [img]="icons.ChevronDown" class="w-5 h-5 text-gray-500 group-hover:text-white transition-transform duration-200" [class.rotate-180]="isDropdownOpen"></lucide-icon>
    </div>

    <div *ngIf="isDropdownOpen"
         class="absolute right-0 top-full mt-2 w-64 dropdown-menu animate-fade-in origin-top-right">
      <div class="p-2 space-y-1">
        <a [routerLink]="['/profile']" (click)="isDropdownOpen = false" class="dropdown-item flex items-center gap-2 w-full text-left">
          <lucide-icon [img]="icons.User" class="w-4 h-4"></lucide-icon> <span>My Profile</span>
        </a>
        <a [routerLink]="['/my-challenges']" (click)="isDropdownOpen = false" class="dropdown-item flex items-center gap-2 w-full text-left">
          <lucide-icon [img]="icons.FileText" class="w-4 h-4"></lucide-icon> <span>My Challenges</span>
        </a>
        <a [routerLink]="['/friends']" (click)="isDropdownOpen = false" class="dropdown-item flex items-center gap-2 w-full text-left">
          <lucide-icon [img]="icons.Users" class="w-4 h-4"></lucide-icon> <span>Friends</span>
        </a>
        <a [routerLink]="['/settings']" (click)="isDropdownOpen = false" class="dropdown-item flex items-center gap-2 w-full text-left">
          <lucide-icon [img]="icons.Settings" class="w-4 h-4"></lucide-icon> <span>Settings</span>
        </a>
      </div>
      <div class="border-t border-gray-700/50 p-2 mt-1">
        <button (click)="onLogout()" class="dropdown-item flex items-center gap-2 w-full text-left" style="color: #f87171;">
          <lucide-icon [img]="icons.LogOut" class="w-4 h-4"></lucide-icon> Log Out
        </button>
      </div>
    </div>

  </div>

  <button class="md:hidden ml-auto text-white p-2" (click)="isMenuOpen = !isMenuOpen">
    <lucide-icon [img]="icons.Menu" class="w-7 h-7"></lucide-icon>
  </button>
</nav>
