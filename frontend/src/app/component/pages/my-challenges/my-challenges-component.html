<section class="p-4 md:p-10 text-white min-h-screen animate-fade-in">
  <div class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
    <div>
      <h2 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500">
        My Challenges
      </h2>
      <p class="text-gray-400">Manage your active quests and creations.</p>
    </div>
    <button (click)="challengeService.isCreateModalOpen.set(true)"
            class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-bold transition shadow-lg hover:scale-105">
      <lucide-icon [img]="icons.PlusCircle" class="w-5 h-5"></lucide-icon>
      New Challenge
    </button>
  </div>

  <div class="flex gap-8 border-b border-gray-700 mb-8 overflow-x-auto">
    <button (click)="switchTab('active')" [class.text-purple-400]="activeTab() === 'active'" [class.border-purple-500]="activeTab() === 'active'" class="pb-3 text-lg font-medium text-gray-400 hover:text-white border-b-2 border-transparent transition whitespace-nowrap">Active</button>
    <button (click)="switchTab('inbox')" [class.text-purple-400]="activeTab() === 'inbox'" [class.border-purple-500]="activeTab() === 'inbox'" class="pb-3 text-lg font-medium text-gray-400 hover:text-white border-b-2 border-transparent transition relative whitespace-nowrap">
      Inbox <span *ngIf="inboxChallenges().length > 0" class="ml-2 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full animate-bounce">{{ inboxChallenges().length }}</span>
    </button>
    <button (click)="switchTab('created')" [class.text-purple-400]="activeTab() === 'created'" [class.border-purple-500]="activeTab() === 'created'" class="pb-3 text-lg font-medium text-gray-400 hover:text-white border-b-2 border-transparent transition whitespace-nowrap">Created by Me</button>
  </div>

  <div [ngSwitch]="activeTab()">
    <div *ngSwitchCase="'inbox'" class="animate-in slide-in-from-bottom-4 duration-300">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div *ngFor="let item of inboxChallenges()" class="bg-[#1a1627] border border-white/5 p-6 rounded-2xl shadow-xl flex flex-col hover:border-purple-500/30 transition-all group">
          <div class="flex justify-between items-start mb-4">
            <div class="flex flex-col gap-2">
              <h4 class="font-bold text-xl mb-1 text-white group-hover:text-purple-400 transition-all duration-300 cursor-pointer relative w-fit challenge-title">
                {{ item.challengeTitle }}
              </h4>
              <span *ngIf="item.category" class="w-fit text-[10px] text-white px-2 py-0.5 rounded font-black uppercase tracking-widest shadow-lg" [ngStyle]="getCategoryStyle(item.category)">{{ item.category }}</span>
            </div>
            <div class="flex flex-col items-end gap-2">
              <span class="text-[10px] bg-purple-900/50 text-purple-300 border border-purple-500/30 px-2 py-1 rounded-md uppercase font-bold shadow-sm">Received</span>
              <span class="text-yellow-400 font-black text-xs flex items-center gap-1 bg-yellow-400/10 px-2 py-1 rounded-full whitespace-nowrap shadow-sm">üèÜ {{ item.points }}</span>
            </div>
          </div>
          <div *ngIf="item.assignedByUsername || item.assignedBy" class="mb-4 p-3 rounded-xl bg-purple-500/5 border border-purple-500/10 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-fuchsia-600 flex items-center justify-center text-sm font-black shadow-lg text-white">{{ (item.assignedByUsername || item.assignedBy).substring(0, 2).toUpperCase() }}</div>
            <div class="flex flex-col"><span class="text-[10px] text-purple-400 uppercase font-black tracking-widest italic">New Challenge from</span><span class="text-sm font-bold text-white">@{{ item.assignedByUsername || item.assignedBy }}</span></div>
          </div>
          <div class="text-[10px] text-gray-500 mb-3 flex items-center gap-1"><span>Original by</span><span class="text-gray-300 font-bold underline decoration-purple-500/30">{{ item.challengeCreatedBy || item.createdBy || 'System' }}</span></div>
          <p class="text-gray-400 text-sm mb-6 flex-grow line-clamp-3 italic opacity-80 border-t border-white/5 pt-4">"{{ item.description }}"</p>
          <div class="flex gap-3 mt-auto pt-4 border-t border-white/5">
            <button (click)="acceptChallenge(item)" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2.5 rounded-xl font-bold text-sm flex justify-center items-center gap-2 shadow-lg transition-all hover:scale-105"><lucide-icon [img]="icons.Check" class="w-4 h-4"></lucide-icon> Accept</button>
            <button (click)="declineChallenge(item)" class="flex-1 bg-red-500/20 hover:bg-red-500/40 text-red-400 border border-red-500/30 py-2.5 rounded-xl font-bold text-sm flex justify-center items-center gap-2 transition-all hover:scale-105"><lucide-icon [img]="icons.X" class="w-4 h-4"></lucide-icon> Decline</button>
          </div>
        </div>
      </div>
    </div>

    <div *ngSwitchCase="'active'" class="animate-in slide-in-from-bottom-4 duration-300">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div *ngFor="let item of activeChallenges()" class="bg-[#1a1627] p-6 rounded-2xl border border-white/5 shadow-2xl flex flex-col h-full hover:border-green-500/30 transition duration-300 group">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
              <span class="text-[10px] font-black text-green-400 border border-green-400/20 px-2 py-0.5 rounded-md uppercase tracking-wider bg-green-400/5">IN PROGRESS</span>
              <span *ngIf="item.category" class="text-[10px] text-white px-2 py-0.5 rounded-md font-bold shadow-md" [ngStyle]="getCategoryStyle(item.category)">{{ item.category }}</span>
            </div>
            <span class="text-yellow-400 font-black text-xs flex items-center gap-1 bg-yellow-400/10 px-2 py-1 rounded-full">üèÜ {{ item.points }}</span>
          </div>
          <h4 class="font-bold text-xl mb-1 text-white group-hover:text-purple-400 transition-all duration-300 cursor-pointer relative w-fit challenge-title">
            {{ item.challengeTitle }}
          </h4>
          <div class="flex items-center justify-between mb-4">
            <div class="text-[10px] text-gray-500 flex items-center gap-1"><span>Original by</span><span class="text-gray-300 font-bold underline decoration-purple-500/50">{{ item.challengeCreatedBy || 'System' }}</span></div>
            <p *ngIf="item.deadline" class="text-[10px] text-red-400 flex items-center gap-1 bg-red-400/5 px-2 py-1 rounded-md border border-red-400/10"><lucide-icon [img]="icons.Clock" class="w-3 h-3"></lucide-icon><span>{{ item.deadline | date:'mediumDate' }}</span></p>
          </div>
          <p class="text-gray-400 text-sm mb-8 line-clamp-3 flex-grow border-t border-white/5 pt-4 italic">{{ item.description }}</p>
          <button (click)="openCompleteModal(item)" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-black py-3 rounded-xl shadow-lg shadow-green-900/20 transition-all flex items-center justify-center gap-2 group mt-auto">
            <lucide-icon [img]="icons.CheckCircle" class="w-5 h-5 group-hover:scale-110 transition-transform"></lucide-icon> Finish Quest
          </button>
        </div>
      </div>
    </div>

    <div *ngSwitchCase="'created'" class="animate-in slide-in-from-bottom-4 duration-300">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div *ngFor="let challenge of myChallenges()" class="bg-[#1a1627] p-6 rounded-2xl border border-white/5 hover:border-blue-500/30 transition-all group flex flex-col h-full shadow-xl">
          <div class="flex justify-between items-start mb-4">
            <span class="px-3 py-1 text-[10px] rounded-full text-white font-black uppercase tracking-tighter shadow-lg" [ngStyle]="getCategoryStyle(challenge.category)">{{ challenge.category }}</span>
            <span class="text-[10px] font-black text-blue-400 border border-blue-400/20 px-2 py-0.5 rounded-md uppercase tracking-widest bg-blue-400/5">{{ challenge.difficulty }}</span>
          </div>
          <h4 class="font-bold text-xl mb-2 text-white group-hover:text-blue-400 transition-all duration-300 cursor-pointer relative w-fit challenge-title">
            {{ challenge.title }}
          </h4>
          <p class="text-gray-400 text-sm mb-6 flex-grow line-clamp-2 italic">"{{ challenge.description }}"</p>
          <div class="pt-4 border-t border-white/5 flex justify-between items-center mt-auto">
            <span class="text-blue-400 font-black text-sm uppercase tracking-widest">{{ challenge.points }} XP REWARD</span>
            <div class="flex gap-1">
              <button (click)="openEditModal(challenge)" class="p-2 hover:bg-blue-500/20 hover:text-blue-400 rounded-xl transition-all"><lucide-icon [img]="icons.Edit" class="w-4 h-4"></lucide-icon></button>
              <button (click)="confirmDelete(challenge)" class="p-2 hover:bg-red-500/20 hover:text-red-400 rounded-xl transition-all"><lucide-icon [img]="icons.Trash2" class="w-4 h-4"></lucide-icon></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<app-challenge-form *ngIf="isEditModalOpen()" [mode]="'edit'" [challengeData]="editChallengeData()" (cancel)="isEditModalOpen.set(false)" (submitChallenge)="onChallengeUpdated($event)"></app-challenge-form>
<app-accept-challenge-modal [isVisible]="isAcceptModalOpen" [challengeTitle]="selectedChallengeForContract?.challengeTitle" (close)="isAcceptModalOpen = false" (confirm)="onContractSigned($event)"></app-accept-challenge-modal>

<app-complete-challenge-modal
  [isVisible]="isCompleteModalOpen"
  [challengeTitle]="selectedChallengeForCompletion?.challengeTitle"
  [xpReward]="selectedChallengeForCompletion?.points"
  (close)="isCompleteModalOpen = false"
  (confirmCompletion)="onChallengeCompleted()">
</app-complete-challenge-modal>

<app-challenge-form *ngIf="challengeService.isCreateModalOpen()" [mode]="'create'" (cancel)="challengeService.isCreateModalOpen.set(false)" (submitChallenge)="onCreateChallenge($event)"></app-challenge-form>

<div *ngIf="isDeleteModalOpen()" class="fixed inset-0 flex items-center justify-center bg-black/90 backdrop-blur-md z-50 animate-in fade-in duration-300">
  <div class="bg-[#1a1627] p-10 rounded-3xl border border-white/10 max-w-md w-full text-center shadow-2xl">
    <div class="w-20 h-20 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">‚ö†Ô∏è</div>
    <h3 class="text-2xl font-black text-white mb-2 uppercase tracking-tighter">Destroy Challenge?</h3>
    <p class="text-gray-400 mb-8">This action is permanent. All associated records will be lost in the void.</p>
    <div class="flex justify-center gap-4">
      <button (click)="isDeleteModalOpen.set(false)" class="flex-1 px-6 py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-white font-bold transition-all">Cancel</button>
      <button (click)="performDelete()" class="flex-1 px-6 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white font-black shadow-lg shadow-red-900/40 transition-all hover:scale-105">Delete</button>
    </div>
  </div>
</div>

<app-toast *ngIf="toastMessage()" [message]="toastMessage()!" [type]="toastType()"></app-toast>

<app-confirmation-modal
  [isVisible]="isDeclineModalOpen"
  title="Abandon Quest?"
  message="Are you sure you want to decline this invitation? It will be removed from your Inbox forever."
  confirmText="Decline"
  type="danger"
  (close)="isDeclineModalOpen = false"
  (confirm)="onConfirmDecline()">
</app-confirmation-modal>
