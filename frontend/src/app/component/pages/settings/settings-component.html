<div class="settings-container animate-fade-in relative">

  <!-- 1. HEADER CENTRAT -->
  <div class="text-center mb-10">
    <h2 class="text-4xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500 inline-block">
      Account Settings
    </h2>
    <p class="text-gray-400">Manage your identity and security preferences.</p>
  </div>

  <!-- 2. AVATAR SECTION -->
  <div class="bg-[#1e1e1e] border border-gray-800 rounded-2xl p-8 mb-8 shadow-xl">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl text-white font-semibold">Choose Avatar</h3>
      <button (click)="saveAvatar()" [disabled]="isLoading()"
              class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed text-sm">
        {{ isLoading() ? 'Saving...' : 'Save Changes' }}
      </button>
    </div>

    <!-- Grid Avatare -->
    <div class="grid grid-cols-3 sm:grid-cols-6 gap-6 justify-items-center">
      <div *ngFor="let avatar of availableAvatars"
           (click)="selectAvatar(avatar)"
           class="avatar-option cursor-pointer relative group transition-all duration-300 transform hover:scale-110"
           [class.selected]="selectedAvatar() === avatar">

        <img [src]="'/avatars/' + avatar"
             class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-transparent transition-all duration-300 object-cover bg-gray-800"
             [class.border-purple-500]="selectedAvatar() === avatar"
             alt="Avatar Option">

        <!-- Checkmark Verde -->
        <div *ngIf="selectedAvatar() === avatar"
             class="absolute -top-1 -right-1 bg-green-500 text-black rounded-full p-1 shadow-lg animate-bounce-small">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. IDENTITY & SECURITY (BUTOANELE MARI) -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

    <!-- Buton: Change Username -->
    <div class="bg-[#1e1e1e] border border-gray-800 rounded-2xl p-6 hover:border-purple-500/50 transition cursor-pointer group"
         (click)="openModal('username')">
      <div class="flex items-center gap-3 mb-2">
        <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition">
          <lucide-icon [img]="icons.User" class="w-6 h-6"></lucide-icon>
        </div>
        <h3 class="font-bold text-white">Username</h3>
      </div>
      <p class="text-gray-400 text-sm mb-4">Change your display name.</p>
      <div class="text-white font-mono bg-black/30 p-2 rounded border border-gray-800 truncate">
        {{ currentUser?.username }}
      </div>
    </div>

    <!-- Buton: Change Email -->
    <div class="bg-[#1e1e1e] border border-gray-800 rounded-2xl p-6 hover:border-purple-500/50 transition cursor-pointer group"
         (click)="openModal('email')">
      <div class="flex items-center gap-3 mb-2">
        <div class="p-2 bg-green-500/10 rounded-lg text-green-400 group-hover:bg-green-500 group-hover:text-white transition">
          <lucide-icon [img]="icons.Mail" class="w-6 h-6"></lucide-icon>
        </div>
        <h3 class="font-bold text-white">Email Address</h3>
      </div>
      <p class="text-gray-400 text-sm mb-4">Update your contact email.</p>
      <div class="text-white font-mono bg-black/30 p-2 rounded border border-gray-800 truncate">
        {{ currentUser?.email }}
      </div>
    </div>

    <!-- Buton: Change Password -->
    <div class="bg-[#1e1e1e] border border-gray-800 rounded-2xl p-6 hover:border-purple-500/50 transition cursor-pointer group"
         (click)="openModal('password')">
      <div class="flex items-center gap-3 mb-2">
        <div class="p-2 bg-red-500/10 rounded-lg text-red-400 group-hover:bg-red-500 group-hover:text-white transition">
          <lucide-icon [img]="icons.Lock" class="w-6 h-6"></lucide-icon>
        </div>
        <h3 class="font-bold text-white">Password</h3>
      </div>
      <p class="text-gray-400 text-sm mb-4">Secure your account.</p>
      <div class="text-gray-500 text-xs">Last changed: Recently</div>
    </div>

  </div>

  <!-- 4. UNIVERSAL MODAL SYSTEM -->
  <div *ngIf="isModalOpen()" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <!-- Backdrop Blur -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" (click)="closeModal()"></div>

    <!-- Modal Content -->
    <div class="bg-[#1a1625] border border-gray-700 rounded-2xl p-8 max-w-md w-full relative z-10 shadow-2xl animate-scale-in">

      <!-- Close Button -->
      <button (click)="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white transition">‚úï</button>

      <!-- PASUL 1: CONFIRMARE -->
      <div *ngIf="modalStep() === 'confirm'" class="text-center">
        <!-- Icon Dinamic -->
        <div class="w-16 h-16 bg-purple-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
          <span *ngIf="activeModalType() === 'username'">üÜî</span>
          <span *ngIf="activeModalType() === 'email'">üìß</span>
          <span *ngIf="activeModalType() === 'password'">üîê</span>
        </div>

        <h3 class="text-2xl font-bold text-white mb-2">
          Change {{ activeModalType() | titlecase }}?
        </h3>
        <p class="text-gray-400 mb-8">
          Are you sure you want to update your {{ activeModalType() }}? This action will affect your profile immediately.
        </p>

        <div class="flex justify-center gap-4">
          <button (click)="closeModal()" class="px-6 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-medium transition">
            Cancel
          </button>
          <button (click)="proceedToForm()" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-bold transition">
            Yes, Continue
          </button>
        </div>
      </div>

      <!-- PASUL 2: FORMULAR -->
      <div *ngIf="modalStep() === 'form'" [ngSwitch]="activeModalType()">

        <!-- A. USERNAME FORM -->
        <div *ngSwitchCase="'username'">
          <h3 class="text-xl font-bold text-white mb-6 text-center">New Username</h3>
          <div class="space-y-4">

            <div class="relative">
              <input type="text" [ngModel]="newUsername()" (ngModelChange)="onUsernameInput($event)"
                     class="w-full bg-[#0f0e13] border rounded-lg p-3 text-white outline-none transition"
                     [class.border-gray-700]="usernameTaken() === null"
                     [class.border-red-500]="usernameTaken() === true"
                     [class.border-green-500]="usernameTaken() === false"
                     placeholder="Enter new username">

              <div *ngIf="isChecking()" class="absolute right-3 top-3.5 animate-spin h-4 w-4 border-2 border-purple-500 border-t-transparent rounded-full"></div>
            </div>

            <!-- Checklist Vizual Username -->
            <div class="bg-black/30 rounded-lg p-4 border border-gray-800 text-sm space-y-1">
              <li [class]="usernameHasLength() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ usernameHasLength() ? '‚úî' : '‚óã' }}</span> Min 3 characters
              </li>
              <li [class]="usernameIsDifferent() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ usernameIsDifferent() ? '‚úî' : '‚óã' }}</span> Different from current
              </li>
              <!--  Checklist Unicitate -->
              <li [class]="usernameIsUnique() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ usernameIsUnique() ? '‚úî' : '‚óã' }}</span> Unique (not taken)
              </li>
            </div>

            <button (click)="onUpdateUsername()" [disabled]="!isUsernameValid() || isLoading() || isChecking()"
                    class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-lg transition disabled:opacity-30 flex justify-center items-center gap-2">
              <span *ngIf="isLoading()" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
              <span>Update Username</span>
            </button>
          </div>
        </div>

        <!-- B. EMAIL FORM -->
        <div *ngSwitchCase="'email'">
          <h3 class="text-xl font-bold text-white mb-6 text-center">New Email Address</h3>
          <div class="space-y-4">

            <div class="relative">
              <input type="email" [ngModel]="newEmail()" (ngModelChange)="onEmailInput($event)"
                     class="w-full bg-[#0f0e13] border rounded-lg p-3 text-white outline-none transition"
                     [class.border-gray-700]="emailTaken() === null"
                     [class.border-red-500]="emailTaken() === true"
                     [class.border-green-500]="emailTaken() === false"
                     placeholder="Enter new email">

              <div *ngIf="isChecking()" class="absolute right-3 top-3.5 animate-spin h-4 w-4 border-2 border-purple-500 border-t-transparent rounded-full"></div>
            </div>

            <!-- Checklist Vizual Email -->
            <div class="bg-black/30 rounded-lg p-4 border border-gray-800 text-sm space-y-1">
              <li [class]="emailHasFormat() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ emailHasFormat() ? '‚úî' : '‚óã' }}</span> Valid email format
              </li>
              <li [class]="emailIsDifferent() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ emailIsDifferent() ? '‚úî' : '‚óã' }}</span> Different from current
              </li>
              <!-- Checklist Unicitate -->
              <li [class]="emailIsUnique() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ emailIsUnique() ? '‚úî' : '‚óã' }}</span> Unique (not used)
              </li>
            </div>

            <button (click)="onUpdateEmail()" [disabled]="!isEmailValid() || isLoading() || isChecking()"
                    class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-lg transition disabled:opacity-30 flex justify-center items-center gap-2">
              <span *ngIf="isLoading()" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
              <span>Update Email</span>
            </button>
          </div>
        </div>

        <!-- C. PASSWORD FORM -->
        <div *ngSwitchCase="'password'">
          <h3 class="text-xl font-bold text-white mb-6 text-center">Update Password</h3>
          <div class="space-y-4">
            <div>
              <label class="text-xs text-gray-400 font-bold ml-1">Current Password</label>
              <input type="password" [ngModel]="currentPassword()" (ngModelChange)="currentPassword.set($event)"
                     class="w-full bg-[#0f0e13] border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 outline-none transition mt-1"
                     placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div>
              <label class="text-xs text-gray-400 font-bold ml-1">New Password</label>
              <input type="password" [ngModel]="newPassword()" (ngModelChange)="newPassword.set($event)"
                     class="w-full bg-[#0f0e13] border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 outline-none transition mt-1"
                     placeholder="New secure password">
            </div>

            <!-- Checklist Vizual Password -->
            <div class="bg-black/30 rounded-lg p-4 border border-gray-800 text-sm space-y-1">
              <li [class]="hasMinLength() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ hasMinLength() ? '‚úî' : '‚óã' }}</span> Min 6 chars
              </li>
              <li [class]="hasUpperCase() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ hasUpperCase() ? '‚úî' : '‚óã' }}</span> Uppercase (A-Z)
              </li>
              <li [class]="hasLowerCase() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ hasLowerCase() ? '‚úî' : '‚óã' }}</span> Lowercase (a-z)
              </li>
              <li [class]="hasNumber() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ hasNumber() ? '‚úî' : '‚óã' }}</span> Number (0-9)
              </li>
              <li [class]="hasSpecialChar() ? 'text-green-400' : 'text-gray-500'" class="flex items-center gap-2">
                <span class="text-xs">{{ hasSpecialChar() ? '‚úî' : '‚óã' }}</span> Special symbol (!@_#)
              </li>
            </div>

            <div>
              <label class="text-xs text-gray-400 font-bold ml-1">Confirm Password</label>
              <input type="password" [ngModel]="confirmPassword()" (ngModelChange)="confirmPassword.set($event)"
                     class="w-full bg-[#0f0e13] border border-gray-700 rounded-lg p-3 text-white focus:border-purple-500 outline-none transition mt-1"
                     placeholder="Repeat password">

              <!-- Match Error -->
              <p *ngIf="confirmPassword() && !passwordsMatch()" class="text-red-400 text-xs mt-1 animate-pulse">Passwords do not match.</p>
            </div>

            <button (click)="onUpdatePassword()" [disabled]="!isPasswordValid() || isLoading()"
                    class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-lg transition disabled:opacity-30 flex justify-center items-center gap-2">
              <span *ngIf="isLoading()" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
              <span>Update Password</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <app-toast *ngIf="showToast()" [message]="toastMessage()" [type]="toastType()"></app-toast>
</div>
